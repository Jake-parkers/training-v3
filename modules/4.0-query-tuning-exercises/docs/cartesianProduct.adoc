= Exercise 3
:icons: font

== Exercise 3: Reducing Cardinality with Aggregation (Preparations)

Before you begin this exercise, you should have completed the steps in the previous exercise.

That is, you must:

. Have a database that has access to the APOC library.

. If you have not populated the database yet, execute this Cypher code to populate the database:

[source,cypher]
----
include::scripts/initialDatabase.cypher[]
----

This is what you should see in the left panel for the database:

[.thumb]
image::InitialDatabase.png[InitialDatabase,width=300]

[start=3]
. Modify the virtual memory and pagecache settings have been adjusted to be:
[square]
* dbms.memory.heap.initial_size=4G
* dbms.memory.heap.max_size=4G
* dbms.memory.pagecache.size=1G

[start=4]
. Warmed up the Page cache (`CALL apoc.warmup.run(true,true,true)`)

You are now ready to start this exercise.

== Exercise 3: Reducing Cardinality with Aggregation (Overview)

In this exercise, you profile queries and optimize them using some best practices.

In this exercise, you will:


* *Exercise 3.3*: Improve a query that returns unrelated data.


Go to the next page to start this exercise.


== Exercise 3.3: Improve a query that returns unrelated data. (Instructions)

*1. Execute this Cypher code to retrieve the titles of all movies  released before 1950 and people born before 1920.*

[source, cypher]
----
PROFILE MATCH (p:Person), (m:Movie)
WHERE  p.born < $bornYear AND m.releaseYear < $releaseYear
RETURN p, m
----

where the $bornYear parameter is set to  1920 and the $releaseYear parameter is set to 1950

*2. What is wrong with this query? Modify this query to optimize it.*

== Exercise 3.3: Improve a query that returns unrelated data.   (Solution)

*1. Execute this Cypher code to retrieve the titles of all movies released before 1920 and people born before 1920.*

[source, cypher]
----
PROFILE MATCH (p:Person), (m:Movie)
WHERE  p.born < $bornYear AND m.releaseYear < $releaseYear
WITH collect(p.name) as people, collect(m.title) as movies
RETURN people, movies
----

where the $bornYear parameter is set to  1920 and the $releaseYear parameter is set to 1950

The result of executing this query should be the following where we see a cartesian product:

[.thumb]
image::EX3.3.png[EX3.3,width=300]

*2. What is wrong with this query? Modify this query to optimize it.*

Here is the solution code:

[source, cypher]
----
PROFILE MATCH (p:Person)
WHERE  p.born < 1920
WITH collect(p.name) AS people
MATCH (m:Movie)
WHERE  m.releaseYear < 1920
WITH collect(m.title) as movies, people
RETURN people, movies
----

The result of executing this code should be:

[.thumb]
image::EX3.3B.png[EX3.3B,width=300]

