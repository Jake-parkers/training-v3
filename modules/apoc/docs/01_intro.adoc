
= APOC for Analytics and Operations
:presenter: Neo Technology
:twitter: neo4j
:email: info@neotechnology.com
:neo4j-version: 4.0
:currentyear: 2020
:doctype: book
:nextsecttitle: The Neo4j Graph Platform
:nextsect: 2
:currsect: 1
:prevsecttitle: About this Course
:prevsect: 0
:toc: left
:toclevels: 4
:experimental:
:imagedir: ../images
//:imagedir: https://s3-us-west-1.amazonaws.com/data.neo4j.com/v4.0-intro-neo4j/img
:manual: http://neo4j.com/docs/developer-manual/current
:manual-cypher: {manual}/cypher


== About this module

[.notes]
--
Neo4j enables developers to create applications that are best architected as graph-powered systems that are built upon the rich connectedness of data.
--

At the end of this training, you should be able to:
[square]
* Thing 1
* Thing 2
* Thing 3


== Agenda

[opts="header"]
|===
| Module | Time
| User-defined functions & procedures in Neo4j |15'
| APOC History, installation, documentation| 15'
| Utility functions |20'
|Data integration| 20'
|Cypher execution |20'
2+| 	BREAK
|Path expansion | 30'
|Graph refactoring | 15'
|TTL & triggers|  20'
|Virtual nodes & relationships + graph grouping | 20'
| Questions, outlook, contribution | 10'
|===

== How do we learn APOC?


* Massively hands-on, lots of exercises
* Help each other!
* Ask questions as they arise.
* Datasets: Movie graph, StackOverflow
* Have the APOC docs open
* Bring your own "How do I?"

== Questions for you

Have you:

* Used built-in procedures in Neo4j?
* Installed and used APOC?
* Used other procedure libraries?
    ** Graph Algorithms, GraphAware NLP, Spatial?
* Written your own procedures/functions?
* Deployed your procedures/functions to production?
* Contributed to APOC or other procedure libraries?

== Extending Neo4j

[.is-half.left]
--
User-defined procedures let you write custom code that:

* Is written in any JVM language
* Accesses the Neo4j Java API
* Is deployed to the database server
* Can be accessed by applications via Cypher
--

[.is-half.right]
image::{imagedir}/extending-neo4j.png[Extending Neo4j]


== Neo4j developer surface

|===
| 2000-2010 | 0.x | Embedded Java API
| 2010-2014 | 1.x | REST
| 2014-2015 | 2.x | Cypher over HTTP
| 2016 |3.0.x|Bolt, Official language drivers, User-defined procedures
|2016|3.1.x|User-defined functions
|2017|3.2.x| User-defined aggregation functions

|===


[.section-title.has-green-background.has-puzzle-background]
== Getting started with Neo4j Desktop

[.section-title.has-purple-background.has-puzzle-background]
== Task: Install Neo4j Desktop


[.section-title.has-purple-background.has-puzzle-background]
== Task: Create & start  a new 4.0 database with the movies graph

[.section-title.has-green-background.has-puzzle-background]
== Usage

== Procedures - Usage

[source,cypher]
----
CALL db.labels()
----

[opts="header"]
|===
| label
| "Movie"
| "Person"
|===

== Procedures - Usage

.Shortcut for non-arg procedures
[source,cypher]
----
CALL db.labels;
----

.Arguments in parentheses
[source,cypher]
----
CALL db.labels();
----

.Deal with results
[source,cypher]
----
CALL db.labels() YIELD label RETURN count(label);
----

.Filter results
[source,cypher]
----
CALL db.labels() YIELD label WHERE label START WITH 'db.' RETURN *;
----

== Listing procedures

[source,cypher]
----
CALL dbms.procedures()
YIELD name, signature, description
WHERE name STARTS WITH "db."
RETURN name, signature
----

[.section-title.has-green-background.has-puzzle-background]
== Built-in procedures & functions

== Built-in procedures

[.is-half.left]
--
* database
* clustering
* security
* monitoring
* schema
* indexing
* configuration
--

[.is-half.right]
--
image::{imagedir}/in-built-procedures.png[inBuiltProcedures]
--


[.statement.is-full]
Reference: https://neo4j.com/docs/operations-manual/current/reference/procedures/


[.section-title.has-purple-background.has-puzzle-background]
== Task: How many procedures exist per group?

[.section-title.has-green-background.has-puzzle-background]
== About APOC

== About APOC

[.is-half.left]
--
* Large standard library of utility  functions and procedures
* Actively developed - many contributors
* "scratch your itch"
* Makes Cypher easier to use
* Enable some specific use-cases
* Plan is to migrate some of the functionality into the Neo4j product
--

[.is-half.right]
--
image::{imagedir}/in-built-procedures.png[inBuiltProcedures]
--

== A history of APOC

* Started life as Michael Hunger's “Fun Project”
* 3.0 was about to have User-defined procedures callable from Cypher but was missing many utility procedures.
* APOC added them and quickly grew from 50 to 150 to 450 procedures & functions
* It's an active OSS project
* It has many contributors and users (100k downloads)

[.section-title.has-green-background.has-puzzle-background]
== Report issues and contribute


[.section-title.has-green-background.has-puzzle-background]
== Ask questions

[.section-title.has-green-background.has-puzzle-background]
== Learn more

== Learn more

* APOC video series at https://r.neo4j.com/apoc-videos[r.neo4j.com/apoc-videos^]
* Documentation at https://www.neo4j.com/docs/labs/apoc[neo4j.com/docs/labs/apoc^]
* Neo4j Browser guide (``:play apoc`)

[.section-title.has-purple-background.has-puzzle-background]
== Task: Open the docs and have a look around

[.section-title.has-green-background.has-puzzle-background]
== Installation

== APOC availability

[.is-half.left]
--
* Neo4j Sandbox
* Neo4j Desktop
* Neo4j Aura
* Docker
--

== APOC on Neo4j Desktop

image of installing in a project

== APOC on Neo4j Server

--
* Download the latest release JAR from https://github.com/neo4j-contrib/neo4j-apoc-procedures/releases/latest[github.com/neo4j-contrib/neo4j-apoc-procedures/releases/latest^]
* Copy into $NEO4J_HOME/plugins
* Remove older versions!
* Add to $NEO4J_HOME/conf/apoc.conf

[source,properties]
----
dbms.security.procedures.unrestricted=apoc.*
----

* Restart server
--

== Docker

[source, bash]
----

----

[.section-title.has-purple-background.has-puzzle-background]
== Task: Install APOC

[.section-title.has-green-background.has-puzzle-background]
== Built-in Help

== Most important slide of the session

[source,cypher]
----
CALL apoc.help("keyword")
----

[.section-title.has-purple-background.has-puzzle-background]
== Task: Search for keywords from the docs

== Text Functions - apoc.text.*

* indexOf, indexesOf
* split, replace, regexpGroups
* format, clean, distance(s)
* capitalize, decapitalize
* random, lpad, rpad
* snakeCase, camelCase, upperCase
* charAt, hexCode
* base64, md5, sha1

https://neo4j.com/docs/labs/apoc/current/misc/text-functions/

[.section-title.has-purple-background.has-puzzle-background]
== Task: Use Text Functions

--
. Return movie titles in ALL CAPS
. Find the top 10 people with similar names based on Levenshtein distance
. Return a `; delimited list of all people whose name starts with "Tom"
--

== Answer: Use Text Functions

.Return movie titles in ALL CAPS
[source,cypher]
----
MATCH (m:Movie)
return m.title, apoc.text.toUpperCase(m.title)
----

== Answer: Use Text Functions

.Find the top 10 people with similar names based on Levenshtein distance
[source,cypher]
----
MATCH (p1:Person), (p2:Person)
WHERE p1 <> p2 AND id(p1) < id(p2)
RETURN p1.name, p2.name,  apoc.text.levenshteinDistance(p1.name, p2.name) AS score
ORDER BY score
LIMIT 10
----

== Answer: Use Text Functions

.Return a `; delimited list of all people whose name starts with "Tom"
[source,cypher]
----
MATCH (p:Person)
WHERE p.name STARTS WITH "Tom"
WITH collect(p.name) AS people
RETURN apoc.text.join(people, ";")
----
