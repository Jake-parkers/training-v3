
= Exercise #11: Managing backups
ifndef::imagesdir[:imagesdir: ../../images]

In this Exercise, you will perform an online backup of a database where you use the same host for the backup process.
Then you will modify the database.
Finally, you will restore the database from the backup to see that it was successfully restored.

[NOTE]
In your real application, if you were to back up a production stand-alone Neo4j instance, you would use a different host from the host that is running the Neo4j instance.

== Before you begin

. Make sure you have a terminal window open to your EC2 instance for this course.
. Ensure that you are the user _neo4j_.

== Exercise steps:

. Modify the Neo4j configuration so that online backup is enabled and will be done on this same host.
For example, your *neo4j.conf* properties should look something like this:

----
dbms.backup.enabled=true
dbms.backup.address=localhost:6362
----

[start=2]
. Restart the Neo4j instance.
. Create a directory named */home/ubuntu/backups* and ensure that it is owned by _neo4j:neo4j_.
. In `cypher-shell`, confirm that all database are started. There should be four databases:
.. system
.. maindb
.. movies
.. movies2
. Confirm that the movies database has 171 nodes:

----
:USE movies
MATCH (n) RETURN count(n);
----

[start=6]
. Perform an online backup of the _system_ database using these guidelines:
.. Perform a consistency check.
.. Use the *backups* directory for the location of the backup.
.. Use the *reports* directory for the report location.

The result of the backup should look something like this:

image::BackupSystem.png[BackupSystem,width=1000,align=center]

[start=7]
. Repeat the backup procedure for the user databases
.. maindb
.. movies
.. movies2
. In `cypher-shell` drop the _movies_ database.
. Use the restore tool to restore the _movies_ database.

You should see something like this:

image::RestoreMovies.png[RestoreMovies,width=1000,align=center]

[start=10]
. In `cypher-shell` create the _movies_ database that was just restored.
. Confirm that the _movies_ database has 171 nodes.

----
MATCH (n) RETURN count(n);
----

[start=12]
. Exit `cypher-shell`.
. Invoke `cypher-shell` to add nodes to the _movies_ database using the *movies.cypher* file.

----
/usr/bin/cypher-shell -u neo4j -p <Neo4jInstancePassword> --database movies < /home/ubuntu/files/movies.cypher
----

[start=14]
. In `cypher-shell` confirm that the database contains 342 nodes:
----
MATCH (n) RETURN count(n);
----

[start=15]
. Perform an online backup using these guidelines:
.. Back up the _movies_ database.
.. Verbose.
.. Perform a consistency check.
.. Use the *backups* directory for the location of the backup

The result of the backup should look as follows:

image::BackupMovies.png[BackupMovies,width=1000,align=center]

[start=16]
. Invoke `cypher-shell` to add more nodes to the _movies_ database using the *movies.cypher* file.

----
/usr/bin/cypher-shell -u neo4j -p <Neo4jInstancePassword> --database movies < /home/ubuntu/files/movies.cypher
----

[start=17]
. In `cypher-shell` confirm that the database contains 513 nodes:
----
MATCH (n) RETURN count(n);
----

[start=18]
. Next, you will restore the _movies_ database to the one that has 342 nodes. Stop the _movies_ database.
. Restore the _movies_ using these guidelines:
.. Use the same _backups_ location.
.. Specify _force_ so that the database will be replaced.
. Connect to the Neo4j instance with `cypher-shell`.
. Start the _movies_ database.
. Confirm that the _movies_ database has 342 nodes.


== Exercise summary

You have gained experience backing up all databases, backing up a single database, and restoring a database.

