
= Configuring Plugins
:doctype: book
:toc: left
:toclevels: 3
:prevsecttitle: Scripting to Manage Databases
:prevsect: 8
:currsect: 9
:nextsecttitle: Managing HTTP Ports
:nextsect: 10
:experimental:
:imagesdir: ../images
:manual: http://neo4j.com/docs/operations-manual/4.0

////
ifdef::backend-html5[]

include::scripts.txt[]

endif::backend-html5[]
////

== About this module

Most applications will take advantage of the many Cypher libraries that are available for use.

At the end of this module, you should be able to:
[square]
* Make a library (plugin) available to applications.
* Confirm that a plugin is available.


== Managing plugins

Some applications can use Neo4j out-of-the-box, but many applications require additional functionality that could be:

[square]
* A library supported by Neo4j such as GraphQL or GRAPH ALGORITHMS.
* A community-supported library, such as APOC.
* Custom functionality that has been written by the developers of your application.

We refer to this additional functionality as a _plugin_ that contains specific procedures.
A _plugin_ is typically specific to a particular release of Neo4j.
In many cases, if you upgrade to a later version of Neo4j, you may also need to install a new, compatible _plugin_.

== Retrieving available procedures

Here is an example of a script you can run to produce a file, *Procedures.txt* that contains the names of the procedures currently available for the Neo4j instance:

----
echo "CALL dbms.procedures() YIELD name;" | /usr/bin/cypher-shell -u neo4j -p <InstancePassword> --format plain > /home/ubuntu/report/DefaultProcedures.txt
----

This script calls a Neo4j built-in procedure, `dbms.procedures()` to return the name of each procedure available to the graph engine at runtime.

Here is an example of a generated *DefaultProcedures.txt* file:

image::DefaultProcedures.png[DefaultProcedures,width=800,align=center]

By default, the procedures available to the Neo4j instance are the built-in procedures that are named db.* and dbms.*.

=== Adding a plugin to the Neo4j instance

To add a plugin to your Neo4j instance, you must first obtain the *.jar* file.
It is important to confirm that the *.jar* file you will use is compatible with the version of Neo4j that you are using.
For example, a plugin released for release 3.5 of Neo4j can be used by a Neo4j 3.5.3 instance, but the converse may not be true.
You must check with the developers of the plugin for compatibility.

Some plugins require a configuration change.
You must understand the configuration changes required for any plugin you are installing.

[NOTE]
When you install Neo4j, the *plugins* directory contains a *README.txt* file that contains instructions related to sandboxing and whitelisting.
These instructions may change in future releases of Neo4j.

== Steps for adding a plugin

. Install the plugin:
.. Download the plugin. If it is a *zip* file unzip the *jar* file.
.. Place the *jar* file in the *plugins* directory for the Neo4j instance.
.. Ensure that the *jar* is owned by _neo4j_ and has execute permissions.
. Configure the plugin:
.. Modify *neo4j.conf* to sandbox the procedures of the plugin.
.. Optionally whitelist the procedures that will be used by the application.
. Restart the Neo4j instance.
. Confirm the procedures of the plugin are available.

==== Sandboxing

Neo4j provides _sandboxing_ to ensure that procedures do not inadvertently use insecure APIs.
For example, when writing custom code it is possible to access Neo4j APIs that are not publicly supported, and these internal APIs are subject to change, without notice.
Additionally, their use comes with the risk of performing insecure actions.
The sandboxing functionality limits the use of extensions to publicly supported APIs, which exclusively contain safe operations,
or contain security checks.

image::DefaultSandboxing.png[DefaultSandboxing,width=800,align=center]

==== Whitelisting

Neo4j _whitelisting_ can be used to allow loading only a few extensions from a larger library.
The configuration setting _dbms.security.procedures.whitelist_ is used to name certain procedures that should be
available from a library.
It defines a comma-separated list of procedures that are to be loaded.
The list may contain both fully-qualified procedure names, and partial names with the wildcard *.


== Example: The APOC plugin

APOC (Awesome Procedures on Cypher) is a very popular plugin used by many applications.
It contains over 450 user-defined procedures that make accessing a graph incredibly efficient and much easier than writing your own Cypher statements to do the same thing.

You obtain the plugin from the APOC https://github.com/neo4j-contrib/neo4j-apoc-procedures/releases[releases] page:

image::APOCOnGitHub.png[APOCOnGitHub,width=800,align=center]

=== Step 1: Install the APOC plugin

Here we download the *.jar* file to the *plugins* directory, change its permissions to execute, and change the owner to be _neo4j:neo4j_.

image::InstallAPOCPluginJar.png[InstallAPOCPluginJar,width=800,align=center]

=== Step 2: Configure the APOC plugin

After you have placed the *.jar* file into the *plugins* directory, you must modify the configuration for the instance as described in the main page for APOC.
As described on the APOC GitHub page, you have an option of either _sandboxing_ or _whitelisting_ the procedures of the plugin.
How much of the APOC library is used by your application is determined by the developers so you should use them as a resource for this type of configuration change.

Suppose we want to allow [.underline]#all# APOC procedures to be available to this Neo4j instance.
We would sandbox the plugin in the *neo4j.conf* file as follows where we specify `dbms.security.procedures.unrestricted=apoc.*`.

image::APOCConfig.png[APOCConfig,width=600,align=center]

[NOTE]
Since APOC is large, you will most likely want to whitebox specific procedures so that only the procedures needed by the application are loaded into the Neo4j instance at runtime.

=== Step 3: Restart the Neo4j instance

And here we see the results after restarting the Neo4j instance:

image::APOCJarLoaded.png[APOCJarLoaded,width=600,align=center]

??You may see some error messages, but you can ignore them as they represent some deprecated functionality of the APOC procedues.


=== Step 4: Confirm the plugin procedures are available

You can produce a report of all the procedures available in the Neo4j instance:

----
echo "CALL dbms.procedures() YIELD name;" | /usr/bin/cypher-shell -u neo4j -p <InstancePassword> --format plain > /home/ubuntu/report/APOCProcedures.txt
----

And here is some of what was produced in the report:

image::APOCProcedures.png[APOCProcedures,width=600,align=center]

[.slide-title.has-gold-background.has-team-background]
== *Exercise #9: Install a plugin*

//ifndef::backend-htlm5[]
Refer to the *Exercise Guide* for instructions.
//endif::[]

//ifdef::backend-htlm5[]
//include::exercises/Exercise09.adoc
//endif::[]


////
[.quiz]
== Check your understanding

=== Question 1

Suppose that you have installed Neo4j Enterprise Edition and have modified the name of the active database in the Neo4j configuration file. What tool and command do you run to create the new database?

Select the correct answer.

[%interactive.answers]
- [ ] `neo4j-admin create-database`
- [ ] `neo4j-admin initialize`
- [ ] `neo4j create-database`
- [x] `neo4j start`

=== Question 2

Suppose that you want the existing Neo4j database to have the name *ABCRecommendations.db*. Assuming that you have stopped the Neo4j instance, what steps must you perform to modify the name of the database, which currently has a default name of *graph.db*?

Select the correct answers.

[%interactive.answers]
- [x] Rename the *NEO4J_HOME/graph.db* directory to *NEO4J_HOME/ABCRecommendations.db*.
- [x] Modify *neo4j.conf* to use _dbms.active_database=ABCRecommendations.db_.
- [ ] Run `neo4j-admin rename graph.db ABCRecommendations.db`.
- [ ] Run `neo4j-admin move graph.db ABCRecommendations.db`.

=== Question 3

How do you copy a database that you want to give to another user?

Select the correct answer.

[%interactive.answers]
- [ ] With the Neo4j instance started, run `neo4j-admin copy` providing the location where the copy will be created.
- [ ] With the Neo4j instance stopped, run `neo4j-admin copy` providing the location where the copy will be created.
- [ ] With the Neo4j instance started, run `neo4j-admin dump` providing the location where the dump file will be created.
- [x] With the Neo4j instance stopped, run `neo4j-admin dump` providing the location where the dump file will be created.
////

== Summary

You should now be able to:

[square]
* Make a library (plugin) available to applications.
* Confirm that a plugin is available.

////
== Grade Quiz and Continue 

++++
<a class="next-section medium button" href="../part-4/">Continue to Module 4</a>
++++

ifdef::backend-html5[]

include::scripts-end.txt[]
++++
<script>
$( document ).ready(function() {
  Intercom('trackEvent','training-admin-view-part3');
});
</script>
++++

endif::backend-html5[]
////
