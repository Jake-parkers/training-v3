
= Managing Backups
:doctype: book
:toc: left
:toclevels: 3
:prevsecttitle: Managing HTTP Ports
:prevsect: 10
:currsect: 11
:nextsecttitle: Importing Data
:nextsect: 12
:experimental:
:imagesdir: ../images
:manual: http://neo4j.com/docs/operations-manual/4.0

////
ifdef::backend-html5[]

include::scripts.txt[]

endif::backend-html5[]
////

== About this module

Online backup is used in production where the application cannot tolerate the database being unavailable.
In this part of the training, you will learn how to back up and restore databases in a Neo4j instance.


== Overview of backup with Neo4j

Backup is an essential process for any deployed application. The Causal Clustering capabilities of Neo4j enable you to provide uninterrupted access to databases because data is replicated in more than one server.
Backup is a little different.
It enables you to take a snapshot of a database or set of databases at a given time.
Backups are essential for a deployed application, especially if some [rogue] application behavior changes the database in a way that cannot be detected or automatically undone.
In this scenario, you need to roll back transactions to a certain point in time.

== Backup architecture

A best practice is to run the backup process from a different system where the Neo4j instance is running.
The backup process is done using the neo4j-admin tool's backup functionality.
This enables the backup performance to not negatively impact the performance of the Neo4j instance that is servicing clients.
What that means is that you must install Neo4j on at least two systems.
You do not configure anything on the server where the backups will be performed from and you do not run a Neo4j instance on that server either.

image::BackupArchitecture.png[BackupArchitecture,width=1200,align=center]

A common practice for many enterprises is to back up their databases to Amazon S3 sites.
In addition, if any backups are to be stored in S3, they should  be encrypted as well as the channel used to create send the backup to S3.

== Backup concepts

When backing up the databases of a Neo4j instance, a best practice is to back up the system database and the user databases.
You perform a full backup initially and during subsequent backups, you back up increments that contain only the data that changed since the last backup.
Another part of the backup process that is important is to confirm that the database being backed up is consistent.

There are other options that you can additionally specify about the backup that you can read about in the _Neo4j Operations Manual_.

== Enabling online backup

To enable a Neo4j instance to be backed up online, you must add these two properties to the *neo4j.conf* file for the Neo4j instance that will be backed up:

<<<<<<< HEAD
=======
`[sudo] bin/neo4j-admin set-initial-password newPassword`

where _newPassword_ is a password you will remember.

[NOTE]
If at some point you have forgotten the admin password for your installation or you need to change it, you can reset the password by following the steps
https://neo4j.com/docs/operations-manual/4.0/configuration/password-and-user-recovery/[here]

=== Post-install: Debian

Initially and *only on Debian*, you should disable _neo4j_ as a service that is started automatically when the system starts.
You do this with this command:

`[sudo] systemctl disable neo4j`

In addition, you should create the directory */var/run/neo4j* that is owned by _neo4j:neo4j_.
This is where the PID for the currently running Neo4j instance is placed.

You will perform these steps later in the Exercise 2.

== Managing the Neo4j instance

When the instance is started, it creates a database directory named *neo4j* in the default location which is a directory under */var/lib/neo4j/data/databases*. You can start and stop the instance regardless of whether the _neo4j_ service is enabled.

You start, stop, restart, and check the status of the Neo4j instance on Debian as follows:

[square]
* `[sudo] systemctl start neo4j`
* `[sudo] systemctl stop neo4j`
* `[sudo] systemctl restart neo4j`
* `systemctl status neo4j`

You start, stop, restart and check the status of the Neo4j instance on non-Debian systems as follows:

[square]
* `[sudo] bin/neo4j start`
* `[sudo] bin/neo4j stop`
* `[sudo] bin/neo4j restart`
* `bin/neo4j status`

When the Neo4j instance starts, it opens the database, and writes to the directories for the database and to the log file.

=== Checking the status of the instance

At any time, you can check the status of the Neo4j instance.

You check the status of the instance as follows:

`systemctl status neo4j`

Here is an example where we check the status of the Neo4j instance:

image::Neo4j_started.png[Neo4j_started,width=800,align=center]

Here we see that the instance is started. Notice that the service is disabled as well.
After the instance is started you can identify the process ID (Main PID) from the status command on Debian.
It is sometimes helpful to know the process ID of the Neo4j instance (JVM) in the event that it is unresponsive and you must kill it.

However, knowing whether the instance is started (active) is generally not sufficient, especially if you have made some configuration changes.
You can view details of the Neo4j instance by examining the log file.

=== Viewing the neo4j log

The status command gives you a short glimpse of the status of the Neo4j instance. In some cases, although the instance is _active_, it may not have started successfully. You may want to examine more information about the instance, such as the directories it is using at runtime and information about activity against the instance, and especially if any errors occurred during startup. As an administrator, you should become familiar with the types of records that are written to the log files for the Neo4j instance.

You can view the log file for the instance on Debian as follows:

[square]
* `journalctl -u neo4j`  to view the entire neo4j log file.
* `journalctl -e -u neo4j` to view the end of the neo4j log file.
* `journalctl -u neo4j -b > neo4j.log` where you can view *neo4j.log* in an editor.

Here is the result from `journalctl` where we want to view then end of the log file:

image::JournalEnd.png[JournalEnd,width=800,align=center]

When the Neo4j instance starts, you can also confirm that it is started by seeing the _Started_ record in the log file.

[NOTE]
You can also view the log file in the *logs* directory on all platforms.

[.slide-title.has-gold-background.has-team-background]
== *Exercise #2: Managing the Neo4j instance*

//ifndef::backend-htlm5[]
Refer to the *Exercise Guide* for instructions.
//endif::[]

//ifdef::backend-htlm5[]
//include::exercises/03_ManagingNeo4jDatabases.adoc
//endif::[]


== Using `cypher-shell`

`cypher-shell` enables you to access the Neo4j database from a terminal window.  You simply log into the database using `cypher-shell` with your credentials:

`/usr/bin/cypher-shell -u <username> -p <password>`

Once authenticated, you enter Cypher statements to execute just as you would in a Neo4j Browser session.
One caveat with `cypher-shell`, however is that all Cypher commands [.underline]#must# end with `;`.
You exit `cypher-shell` with the command `:exit`.

=== Example: Using `cypher-shell`

Here is an example showing that we can successfully log in to the database for the Neo4j instance, providing the default credentials _neo4j/neo4j_:
Since this is the first login to the database, you must change the password from _neo4j_ to a password you will remember.

image::InitialLogin-cypher-shell.png[InitialLogin-cypher-shell,width=800,align=center]

In this example we changed the password to _training-helps_.

When you are done with `cypher-shell`, you enter `:exit` to exit.

[NOTE]
If you set the environment variables NEO4J_USER and NEO4J_PASSWORD with their respective values, then you need not enter your credentials when logging into `cypher-shell`.


=== Example: Using `cypher-shell` providing credentials as arguments

You can also specify the username and password at the command level to use `cypher-shell` as arguments .

image::Cypher-shell-withParms.png[Cypher-shell-withParms,width=800,align=center]

== Accessing the system database

After you have successfully logged in to the Neo4j instance using `cypher-shell`, you can execute system commands against the Neo4j instance.
By default, you are connected to the default Neo4j database, _neo4j_, which is a user database.

System commands use the _system_ database and are primarily used to:

* View the status of the databases being served by the Neo4j instance
* Create or drop a user database.
* Start or stop a user database.

To access the system database, you enter `:USE system`.

image::UseSystem.png[UseSystem,width=1000,align=center]

Notice that the prompt neo4j@system tells us that all commands we enter will be against the system database.

=== Viewing databases for the Neo4j instance

Using the _system_ database, you can view all of the databases served by this Neo4j instance by entering the command `SHOW DATABASES;`:

[NOTE] For all commands and cypher statements, you must end them with the `;` character.

image::ShowInitialDatabases.png[ShowInitialDatabases,width=1000,align=center]

Here we see that this Neo4j instance that we have connected to has the system database and the neo4j database, which is the default name of the user database.
A Neo4j instance has one system database and any number of user databases.
After you have created more than one user database, you can configure any single user database as the default database.

=== Selecting the user database to access

In a client session, you can only access a single user database at a time, even though multiple databases may be online (started).
You use the :USE command to select the user database to connect to.

Here we switch back to the default, _neo4j_ user database by specifying `:USE neo4j`.
Then you can create or access the data in this user database.
For example, we access the user database by creating a node with the label, _Person_ and a _name_ of "John Doe", retrieving it, and then deleting it.

image::AccessUserDatabase.png[AccessUserDatabase,width=1000,align=center]

=== Sending Cypher statements to the `cypher-shell` session

When you log in to `cypher-shell`, you are connected to the default database, which is by default, _neo4j_.

You can use `cypher-shell` to populate the default database by sending pre-written Cypher statements to the database to execute.

image::ImportCypher.png[ImportCypher,width=1000,align=center]

Here we have download a file named *movieDB.cypher* that contains the Cypher statements to create the Movie graph.
We simply use these Cypher statements as input when we start the `cypher-shell` session.
They are automatically executed against the default database, _neo4j_.

[.slide-title.has-gold-background.has-team-background]
== *Exercise #3: Using `cypher-shell`*

//ifndef::backend-htlm5[]
Refer to the *Exercise Guide* for instructions.
//endif::[]

//ifdef::backend-htlm5[]
//include::exercises/03_ManagingNeo4jDatabases.adoc
//endif::[]

== Creating databases

In Neo4j 4.0 Enterprise Edition, a Neo4j instance can host multiple user databases. To create a database, you connect to a started Neo4j instance with `cypher-shell`.

Here are the commands to create a database:

----
:USE system
CREATE DATABASE <database-name>
----

The database must not already exist (Check with the `SHOW DATABASES` command). This command creates the database and starts it.

Here are some database naming rules:

* Length must be between 3 and 63 characters.
* The first character of a name must be an ASCII alphabetic character.
* Subsequent characters must be ASCII alphabetic or numeric characters, dots or dashes; [a..z][0..9].-
* Names are case-insensitive and normalized to lowercase.
* Names that begin with an underscore and with the prefix system are reserved for internal use.
* All of the above commands are executed as Cypher commands, and the database name is subject to the standard Cypher restrictions on valid identifiers. In particular, the - (dash) character is not legal in Cypher variables, and therefore names with dashes need to be escaped by enclosing with back-ticks. For example, CREATE DATABASE `main-db`.

Once a database is created, you cannot rename it.

=== Creating a database

Here we create a database named _myfirstdatabase_:

image::CreateDatabase.png[CreateDatabase,width=1000,align=center]

You can view the directory created for the database:

image::DatabaseFiles.png[DatabaseFiles,width=1000,align=center]

== Starting and stopping a database

When a database is started, it uses VM resources. If the application is not actively using a database, you can stop it or restart it as needed.

image::StopStartDatabase.png[StopStartDatabase,width=1000,align=center]

== Initial database configuration settings

The *neo4j.conf* file contains settings related to the name of the default database.

`dbms.default_database` specifies the default database clients will connect to when they do not specify a specific database.

`dbms.max_databases` specifies the maximum number of databases the Neo4j instance will allow.

image::ChangeDefaultDatabase.png[ChangeDefaultDatabase,width=1000,align=center]

[NOTE]
Whenever you make a change to the *neo4j.conf* file, you must restart the Neo4j instance. (`[sudo] systemctl restart neo4j`)
A best practice is to examine the log file for the Neo4j instance after you have made any configuration changes to ensure that the instance starts with no errors.

== Deleting a database

You delete a database as shown here where we drop the database _neo4j_.
We can drop it because it is no longer the default database.
You need not stop the database before your drop it, but dropping it is a permanent deletion of the database.

image::DropDatabase.png[DropDatabase,width=1000,align=center]

== Resetting a database

Suppose you have a database that has been populated with data, constraints, and/or indexes.
You want to reuse the database and reset it to be empty with no data, constraints, or indexes.
One way that you can achieve this is to drop the database and then create it again.
Another way that you can do is is to use the following command:

----
CREATE OR REPLACE <database>;
----

== Conditionally creating a database

If you are scripting the creation of databases, you can also create a database if it does not exist as follows:

----
CREATE <database> IF NOT EXISTS;
----

[NOTE]
You cannot use `CREATE OR REPLACE` together with `IF NOT EXISTS`.

[.slide-title.has-gold-background.has-team-background]
== *Exercise #4: Creating and deleting a database*

//ifndef::backend-htlm5[]
Refer to the *Exercise Guide* for instructions.
//endif::[]

//ifdef::backend-htlm5[]
//include::exercises/03_ManagingNeo4jDatabases.adoc
//endif::[]


== Copying a Neo4j database

You or one of your application developers may want to copy a Neo4j database.
Perhaps the developers are at a juncture in their development where they want to save what they have worked on thus far.
Or perhaps they want to give a copy of the database to another developer to work with on a different system.

The structure of a Neo4j database is proprietary and could change from one release to another.
You should [underline]#never# copy the database files from one location in the filesystem/network to another location.

There are two ways that you can copy a database:

. Create a copy within the same Neo4j instance.
. Create a copy (dump file) that you will give to another developer to load into their Neo4j instance running on a different system.

=== Copying a database within the same Neo4j instance

To copy a database within the same Neo4j instance, the source database must be stopped.
Additionally, the target database that you will be creating must not exist.

You use the `neo4j-admin` tool to copy a database within your Neo4j instance. Here are the steps:

. Ensure the Neo4j instance is started.
. In `cypher-shell` stop the source database you want to copy.
. Exit `cypher-shell`.
. In a different terminal window, enter this as the user, neo4j:
----
/usr/bin/neo4j-admin copy --from-database=<sourceDB> --to-database=<targetDB>
----
[start=5]
. In `cypher-shell' create <targetDB>.

There are other options you can use to customize what is copied. See the _Neo4j Operations Manual_ for details.

=== Creating a dump file from a database

To create a dump file of a database, you must:

. Ensure the Neo4j instance is started.
. Stop the database you want to dump.
. Ensure that the directory where you will dump the database exists.
[start=4]
. As the neo4j users, you can use the `dump` command of the `neo4j-admin` tool to create the dump file as follows:
----
/usr/bin/neo4j-admin dump --database=<sourceDB> --to=<absolute path to dump file>
----

Note that the user, neo4j, must have write access to the directory.

This will create a  dump file that can now be transferred between systems to create a new database on a different system.

=== Creating a database from a dump file

Then, if you want to create a database from any offline backup file to use for a Neo4j instance, you must:

. Use the `load` command of the `neo4j-admin` tool as the neo4j users, to create the database from the dump file as follows:
----
/usr/bin/neo4j-admin load --database=<targetDB> --from=<absolute path to dump file>
----
[start=2]
. In `cypher-shell' create <targetDB>.

[.slide-title.has-gold-background.has-team-background]
== *Exercise #5: Copying databases*

//ifndef::backend-htlm5[]
Refer to the *Exercise Guide* for instructions.
//endif::[]

//ifdef::backend-htlm5[]
//include::exercises/03_ManagingNeo4jDatabases.adoc
//endif::[]


== Modifying the location of the database

If you do not want the databases used by the Neo4j instance to reside in the same location as the Neo4j installation, you can modify its location in the *neo4j.conf* file. If you specify a new location for the data, it must exist in the filesystem and the directory must be owned by _neo4j:neo4j_.

Here we have specified a new location for the data in the configuration file:

image::ChangeDatabaseDirectory.png[ChangeDatabaseDirectory,width=800,align=center]

In addition, we have specified mainDB as the default database.

=== Best practice for configuration modifications

Here is a best practice you should follow when managing a Neo4j installation.
It is easier to place all changed property values at the end of the *neo4j.conf* file.
That way, you can easily see what non-default values you have configured.

Here is an example:

image::BestPracticeConfigChangesAtEnd.png[BestPracticeConfigChangesAtEnd,width=800,align=center]

=== Starting Neo4j instance with a new location

After you have modified the *neo4j.conf* file with the new location for the databases, you must:

. Ensure the directory exists.
. Change the owner of the directory to be neo4j.
. Start or restart the Neo4j instance.
. Confirm that the instance started with no errors.

image::Neo4jStarted-newLocation1.png[Neo4jStarted-newLocation1,width=800,align=center]

When you start the Neo4j instance using a different location for the databases, it first creates and starts a database named whatever you have specified as the default database.
If you did not specify the default database in the configuration file, it will create a database named _neo4j_.

Here are the new databases in the new location:

image::Neo4jStarted-newLocation2.png[Neo4jStarted-newLocation2,width=800,align=center]

If you have existing databases that you want to reside in a different location for the Neo4j instance, remember that you must dump and load the databases to safely copy them to the new location.

==== Password change required

Just as you needed to change the password for the admin user, neo4j the first time you accessed a database, you must do the same here for this new location of the Neo4j databases:

image::passwordChangeNewLocation.png[passwordChangeNewLocation,width=800,align=center]

[.slide-title.has-gold-background.has-team-background]
== *Exercise #6: Modifying the location of the databases*

//ifndef::backend-htlm5[]
Refer to the *Exercise Guide* for instructions.
//endif::[]

//ifdef::backend-htlm5[]
//include::exercises/03_ManagingNeo4jDatabases.adoc
//endif::[]


== Checking the consistency of a database

A database's consistency could be compromised if a software or hardware failure has occurred that affects the Neo4j database.
You will learn later in this module about live backups, but if you have reason to believe that a specific database has been corrupted,  you can perform a consistency check on it.

The Neo4j database must be stopped to perform the consistency check.

Here is how you use the `neo4j-admin` tool to check the consistency of the database:

`neo4j-admin check-consistency --database=<database-name> --report-dir=report-location [--verbose]`

The database named _database-name_ is found in the Neo4j instance.
If the tool comes back with no error, then the database is consistent.
Otherwise, an error is returned and a report is written to _report-location_.
You can specify verbose reporting. See the https://neo4j.com/docs/operations-manual/4.0/tools/consistency-checker/[Neo4j Operations Manual] for more options. For example, you can check the consistency of a backup which is a best practice.

Suppose we had loaded the *movies2* database with `neo4j-admin`. Here is what a successful run of the consistency checker should produce:

image::ConsistentPassed.png[ConsistentPassed,width=1000,align=center]

No report is written to the reports directory because the consistency check passed.

=== Inconsistencies found

Here is an example of what an unsuccessful run of the consistency checker should produce:

image::Inconsistencies.png[Inconsistencies,width=1000,align=center]

If inconsistencies are found, a report is generated and placed in the directory specified for the report location.

Inconsistencies in a database are a serious matter that should be looked into with the help of Neo4j Technical Support. 

[.slide-title.has-gold-background.has-team-background]
== *Exercise #7: Checking consistency of a database*

//ifndef::backend-htlm5[]
Refer to the *Exercise Guide* for instructions.
//endif::[]

//ifdef::backend-htlm5[]
//include::exercises/03_ManagingNeo4jDatabases.adoc
//endif::[]

== Scripting with cypher-shell

As a database administrator, you may need to automate changes to databases.
The most common types of changes that administrators may want to perform are related to the application.
As an administrator, you work with architects and developers to created scripts to:

* Create or drop databases
* Create constraints
* Create indexes
* Load data
* Update data
* Restructure the graph (change graph data model)
* Add users and access control.

=== Examples: Adding constraints

Suppose that we create 3 files to make changes:

*1. AddConstraintsMovies.cypher* that contains the Cypher statements to execute in `cypher-shell`:
----
CREATE CONSTRAINT ON (m:Movie) ASSERT m.title IS UNIQUE;
CREATE CONSTRAINT ON (p:Person) ASSERT p.name IS UNIQUE;
CALL db.constraints();
>>>>>>> f6c22c4864ecebd7f80d433329b5e0bb2f60001b
----
dbms.backup.enabled=true
dbms.backup.address=<host-address>:<6362-6372>
----

Where _host-address_ is the address of a server from which you will run neo4j-admin to perform the backup.
You must specify a port number that will not conflict with existing ports used on the server being backed up.

<<<<<<< HEAD
=== Performing the backup
=======
[.slide-title.has-gold-background.has-team-background]
==  *Exercise #8: Scripting changes to the database*

//ifndef::backend-htlm5[]
Refer to the *Exercise Guide* for instructions.
//endif::[]

//ifdef::backend-htlm5[]
//include::exercises/03_ManagingNeo4jDatabases.adoc
//endif::[]


== Managing plugins

Some applications can use Neo4j out-of-the-box, but many applications require additional functionality that could be:

[square]
* A library supported by Neo4j such as GraphQL or GRAPH ALGORITHMS.
* A community-supported library, such as APOC.
* Custom functionality that has been written by the developers of your application.

We refer to this additional functionality as a _plugin_ that contains specific procedures. A _plugin_ is typically specific to a particular release of Neo4j. In many cases, if you upgrade to a later version of Neo4j, you may also need to install a new _plugin_. First, you should understand how to view the procedures available for use with the Neo4j instance. You do so by executing the Cypher statement `CALL db.procedures();`.

=== Retrieving available procedures
>>>>>>> f6c22c4864ecebd7f80d433329b5e0bb2f60001b

After you restart the Neo4j instance with the configuration changes, you can then initiate the backup on the server you specified in _host_address_ as follows with consistency checking:

[listing]
----
neo4j-admin backup --backup-dir=<backup-directory>
                   [--verbose]
                   --from=<Neo4j-instance-host-address:<port>
                   [--database=<database-name>]
                   --check-consistency
                   --report-dir=<report-directory>
----

If you do not specify a database, it will back up all databases.
If a database has previously been backed up to the backup directory, the backup will be for any changes since the last backup.

There are a number of other options you can specify related to performance and specific types of checks.
See the documentation for details.

If the backup was successful it returns 0.
If a non-zero value is returned, the backup failed or a consistency check failed, both of which need to be investigated.

<<<<<<< HEAD
One thing that you need to determine is whether the consistency checking will be done during the backup or on the backup image after the backup has completed.
If you need to speed up the backup process and whether it taxes the Neo4j instance, then it will be better to check the consistency after the backup.
=======
=== Example: Installing the APOC plugin

https://github.com/neo4j-contrib/neo4j-apoc-procedures[APOC] (Awesome Procedures on Cypher) is a very popular plugin used by many applications. It contains over 450 user-defined procedures that make accessing a graph incredibly efficient and much easier than writing your own Cypher statements to do the same thing.

You obtain the plugin from the APOC https://github.com/neo4j-contrib/neo4j-apoc-procedures/releases[releases] page:

image::APOCDownloadPage.png[APOCDownloadPage,width=800,align=center]

ifdef::backend-pdf[]
// force page break
<<<
endif::backend-pdf[]

==== Example: Download and ownership of plugin

Here we download the *.jar* file, change its permissions to execute, and change the owner to be _neo4j:neo4j_.

image::APOC.png[APOC,width=800,align=center]

ifdef::backend-pdf[]
// force page break
<<<
endif::backend-pdf[]

==== Example: Sandboxing

After you have placed the *.jar* file into the *plugins* directory, you must modify the configuration for the instance as described in the main page for APOC. As described on this page, you have an option of either _sandboxing_ or _whitelisting_ the procedures of the plugin. How much of the APOC library is used by your application is determined by the developers so you should use them as a resource for this type of configuration change.

Suppose we want to allow [.underline]#all# APOC procedures to be available to this Neo4j instance. We would sandbox the plugin in the *neo4j.conf* file as follows, similar to how we sandboxed the graph algorithms where we specify `dbms.security.procedures.unrestricted=algo.*,apoc.*`.

image::APOCConfig.png[APOCConfig,width=600,align=center]

Since APOC is large, you will most likely want to whitebox specific procedures so that only the procedures needed by the application are loaded into the Neo4j instance at runtime.

ifdef::backend-pdf[]
// force page break
<<<
endif::backend-pdf[]

==== Example: Restart with plugin

And here we see the results after restarting the Neo4j instance and running the script to list the procedures loaded in the instance:

image::APOCLoaded.png[APOCLoaded,width=600,align=center]

ifdef::backend-pdf[]
// force page break
<<<
endif::backend-pdf[]

===  *Exercise #7: Install a plugin*

In this Exercise, you will install the Spatial library for use by your Neo4j instance and you will create and execute a script to report all of the procedures available to the Neo4j instance.

*Before you begin*:

. Stop the Neo4j instance.
. Make sure you have a terminal window open for executing test commands.

*Exercise steps*:

. In a Web browser, go to the GitHub repository for the https://github.com/neo4j-contrib/spatial[Neo4j Spacial Library].
. On the main page for this repository, find the latest release of the library that is compatible with your version of Neo4j Enterprise Edition.
. Download the already-built *.jar* file into the */var/lib/neo4j/plugins* directory.
. Ensure that the file size is correct and that the file name ends with *.jar*.
. Change the owner of the *.jar* file to _neo4j:neo4j_ and add execute permissions to the file.
. Restart the Neo4j instance.
. Follow the steps on the GitHub page for testing the library.

For example, you should see the following in the repository main page:

image::L03-Ex7-GetSpatialLibrary.png[Ex7-GetSpatialLibrary,width=800,align=center]

ifdef::backend-pdf[]
// force page break
<<<
endif::backend-pdf[]

Here is how you download the *.jar* file into the */var/lib/neo4j/plugins* directory. You should confirm that the file size is correct and that the owner is _neo4j:neo4j_ with execute permissions.

image::L03-Ex7-SpatialLibrary.png[Ex7-SpatialLibrary,width=800,align=center]


Here is what you should see when you execute the first `curl` command:

image::L03-Ex7-SpatialQuery1.png[Ex7-SpatialQuery1,width=1000,align=center]

Here is what you should see when you execute the second `curl` command:

image::L03-Ex7-SpatialQuery2.png[Ex7-SpatialQuery2,width=1000,align=center]

[start=8]
. In the */usr/local/work* directory, create a script named *ListProcedures.sh* that will write the list of procedures available to the Neo4j instance to the */usr/local/work/Procedures.txt* file.

ifdef::backend-pdf[]
// force page break
<<<
endif::backend-pdf[]

[start=9]
. Run the *ListProcedures.sh* script and examine the contents to also verify that the plugin has been installed. The *Procedures.txt* file should contain these items:

image::L03-Ex7-SpatialLibraryLoaded.png[Ex7-SpatialLibraryLoaded,width=600,align=center]


== Configuring connector ports for the Neo4j instance

The Neo4j instance uses https://neo4j.com/docs/operations-manual/3.5/configuration/ports/[default port numbers] that may conflict with other processes on your system. The ports frequently used are the connector ports:

[cols="10,10,80", options="header",stripes="none"]
|====
| *Name*
| *Port Number*
| *Description*
|
{set:cellbgcolor:white}
 HTTP
| 7474
| Used by Neo4j Browser and REST API. It is *not* encrypted so it should never be exposed externally.
| HTTPS
| 7473
| Used by REST API. Requires additional SSL configuration.
| Bolt
| 7687
| Bolt connection used by Neo4j Browser, cypher-shell, and client applications.
|====
{set:cellbgcolor!}

=== Modifying the default connector ports

If any of these ports conflict with ports already used on your system, you can change these connector ports by modifying these property values in the *neo4j.conf* file:

----
# Bolt connector
dbms.connector.bolt.enabled=true
#dbms.connector.bolt.tls_level=OPTIONAL
#dbms.connector.bolt.listen_address=:*7687*

# HTTP Connector. There can be zero or one HTTP connectors.
dbms.connector.http.enabled=true
#dbms.connector.http.listen_address=:*7474*

# HTTPS Connector. There can be zero or one HTTPS connectors.
dbms.connector.https.enabled=true
#dbms.connector.https.listen_address=:*7473*
----

As you learn more about some of the other administrative tasks for a Neo4j instance, you will work with other ports.
>>>>>>> f6c22c4864ecebd7f80d433329b5e0bb2f60001b

[NOTE]
In most cases, you will need to set the HEAP_SIZE environment variable before you start the backup process.

=== Restore architecture

You use the `neo4j-admin` tool to restore a database.
You run the restore process on the same system where the Neo4j instance resides.

image::RestoreArchitecture.png[RestoreArchitecture,width=1200,align=center]

If you need to restore all databases, then you can first shut down the Neo4j instance and restore all of them.

If you need to restore a specific database, you must ensure that the Neo4j instance is started, but the database that you want to restore is stopped.

=== Restoring from a backup

If you need to restore a specific database from a backup, you must first stop the database you want to restore.

Here is how you restore the database from a backup:

[listing]
----
neo4j-admin restore
          --from=<absolute-path-to-backup-instance-directory-name>
          --database=<database-name>
          [--force]
          [--verbose]
----

If you specify _--force_, the existing database will be replaced.
You then need to create it again against the _system_ database.


[NOTE]
If you restore a database as _root_ with _--force_, make sure that you change the ownership (recursively) of the database directory to _neo4j:neo4j_ before creating the database.

[.title.has-gold-background.has-team-background]
== *Exercise #11: Managing backups*

//ifndef::backend-htlm5[]
Refer to the *Exercise Guide* for instructions.
//endif::[]

//ifdef::backend-htlm5[]
//include::exercises/Exercise11.adoc
//endif::[]


//[#module-3.quiz]
////
== Check your understanding

=== Question 1

Suppose that you have installed Neo4j Enterprise Edition and have modified the name of the active database in the Neo4j configuration file. What tool and command do you run to create the new database?

Select the correct answer.

[%interactive.answers]
- [ ] `neo4j-admin create-database`
- [ ] `neo4j-admin initialize`
- [ ] `neo4j create-database`
- [x] `neo4j start`

=== Question 2

Suppose that you want the existing Neo4j database to have the name *ABCRecommendations.db*. Assuming that you have stopped the Neo4j instance, what steps must you perform to modify the name of the database, which currently has a default name of *graph.db*?

Select the correct answers.

[%interactive.answers]
- [x] Rename the *NEO4J_HOME/graph.db* directory to *NEO4J_HOME/ABCRecommendations.db*.
- [x] Modify *neo4j.conf* to use _dbms.active_database=ABCRecommendations.db_.
- [ ] [Run `neo4j-admin rename graph.db ABCRecommendations.db`.
- [ ] Run `neo4j-admin move graph.db ABCRecommendations.db`.

=== Question 3

How do you copy a database that you want to give to another user?

Select the correct answer.

[%interactive.answers]
- [ ] With the Neo4j instance started, run `neo4j-admin copy` providing the location where the copy will be created.
- [ ] With the Neo4j instance stopped, run `neo4j-admin copy` providing the location where the copy will be created.
- [ ] With the Neo4j instance started, run `neo4j-admin dump` providing the location where the dump file will be created.
- [x] With the Neo4j instance stopped, run `neo4j-admin dump` providing the location where the dump file will be created.
////

== Summary

You should now be able to back up and restore a Neo4j database.

////
== Grade Quiz and Continue 

++++
<a class="next-section medium button" href="../part-4/">Continue to Module 4</a>
++++

ifdef::backend-html5[]

include::scripts-end.txt[]
++++
<script>
$( document ).ready(function() {
  Intercom('trackEvent','training-admin-view-part3');
});
</script>
++++

endif::backend-html5[]
////
