
= Managing Backups
:doctype: book
:toc: left
:toclevels: 3
:prevsecttitle: Managing HTTP Ports
:prevsect: 10
:currsect: 11
:nextsecttitle: Importing Data
:nextsect: 12
:experimental:
:imagesdir: ../images
:manual: http://neo4j.com/docs/operations-manual/4.0

////
ifdef::backend-html5[]

include::scripts.txt[]

endif::backend-html5[]
////

== About this module

Online backup is used in production where the application cannot tolerate the database being unavailable.
In this part of the training, you will learn how to back up and restore databases in a Neo4j instance.


== Overview of backup with Neo4j

Backup is an essential process for any deployed application. The Causal Clustering capabilities of Neo4j enable you to provide uninterrupted access to databases because data is replicated in more than one server.
Backup is a little different.
It enables you to take a snapshot of a database or set of databases at a given time.
Backups are essential for a deployed application, especially if some [rogue] application behavior changes the database in a way that cannot be detected or automatically undone.
In this scenario, you need to roll back transactions to a certain point in time.

== Backup architecture

A best practice is to run the backup process from a different system where the Neo4j instance is running.
The backup process is done using the neo4j-admin tool's backup functionality.
This enables the backup performance to not negatively impact the performance of the Neo4j instance that is servicing clients.
What that means is that you must install Neo4j on at least two systems.
You do not configure anything on the server where the backups will be performed from and you do not run a Neo4j instance on that server either.

image::BackupArchitecture.png[BackupArchitecture,width=1200,align=center]

A common practice for many enterprises is to back up their databases to Amazon S3 sites.
In addition, if any backups are to be stored in S3, they should  be encrypted as well as the channel used to create send the backup to S3.

== Backup concepts

When backing up the databases of a Neo4j instance, a best practice is to back up the system database and the user databases.
You perform a full backup initially and during subsequent backups, you back up increments that contain only the data that changed since the last backup.
Another part of the backup process that is important is to confirm that the database being backed up is consistent.

There are other options that you can additionally specify about the backup that you can read about in the _Neo4j Operations Manual_.

== Enabling online backup

To enable a Neo4j instance to be backed up online, you must add these two properties to the *neo4j.conf* file for the Neo4j instance that will be backed up:

----
dbms.backup.enabled=true
dbms.backup.address=<host-address>:<6362-6372>
----

Where _host-address_ is the address of a server from which you will run neo4j-admin to perform the backup.
You must specify a port number that will not conflict with existing ports used on the server being backed up.


=== Performing the backup

After you restart the Neo4j instance with the configuration changes, you can then initiate the backup on the server you specified in _host_address_ as follows with consistency checking:

[listing]
----
neo4j-admin backup --backup-dir=<backup-directory>
                   [--verbose]
                   --from=<Neo4j-instance-host-address:<port>
                   [--database=<database-name>]
                   --check-consistency
                   --report-dir=<report-directory>
----

If you do not specify a database, it will back up all databases.
If a database has previously been backed up to the backup directory, the backup will be for any changes since the last backup.

There are a number of other options you can specify related to performance and specific types of checks.
See the documentation for details.

If the backup was successful it returns 0.
If a non-zero value is returned, the backup failed or a consistency check failed, both of which need to be investigated.

One thing that you need to determine is whether the consistency checking will be done during the backup or on the backup image after the backup has completed.
If you need to speed up the backup process and whether it taxes the Neo4j instance, then it will be better to check the consistency after the backup.

[NOTE]
In most cases, you will need to set the HEAP_SIZE environment variable before you start the backup process.

=== Restore architecture

You use the `neo4j-admin` tool to restore a database.
You run the restore process on the same system where the Neo4j instance resides.

image::RestoreArchitecture.png[RestoreArchitecture,width=1200,align=center]

If you need to restore all databases, then you can first shut down the Neo4j instance and restore all of them.

If you need to restore a specific database, you must ensure that the Neo4j instance is started, but the database that you want to restore is stopped.

=== Restoring from a backup

If you need to restore a specific database from a backup, you must first stop the database you want to restore.

Here is how you restore the database from a backup:

[listing]
----
neo4j-admin restore
          --from=<absolute-path-to-backup-instance-directory-name>
          --database=<database-name>
          [--force]
          [--verbose]
----

If you specify _--force_, the existing database will be replaced.
You then need to create it again against the _system_ database.


[NOTE]
If you restore a database as _root_ with _--force_, make sure that you change the ownership (recursively) of the database directory to _neo4j:neo4j_ before creating the database.

[.title.has-gold-background.has-team-background]
== *Exercise #11: Managing backups*

//ifndef::backend-htlm5[]
Refer to the *Exercise Guide* for instructions.
//endif::[]

//ifdef::backend-htlm5[]
//include::exercises/Exercise11.adoc
//endif::[]


//[#module-3.quiz]
////
== Check your understanding

=== Question 1

Suppose that you have installed Neo4j Enterprise Edition and have modified the name of the active database in the Neo4j configuration file. What tool and command do you run to create the new database?

Select the correct answer.

[%interactive.answers]
- [ ] `neo4j-admin create-database`
- [ ] `neo4j-admin initialize`
- [ ] `neo4j create-database`
- [x] `neo4j start`

=== Question 2

Suppose that you want the existing Neo4j database to have the name *ABCRecommendations.db*. Assuming that you have stopped the Neo4j instance, what steps must you perform to modify the name of the database, which currently has a default name of *graph.db*?

Select the correct answers.

[%interactive.answers]
- [x] Rename the *NEO4J_HOME/graph.db* directory to *NEO4J_HOME/ABCRecommendations.db*.
- [x] Modify *neo4j.conf* to use _dbms.active_database=ABCRecommendations.db_.
- [ ] [Run `neo4j-admin rename graph.db ABCRecommendations.db`.
- [ ] Run `neo4j-admin move graph.db ABCRecommendations.db`.

=== Question 3

How do you copy a database that you want to give to another user?

Select the correct answer.

[%interactive.answers]
- [ ] With the Neo4j instance started, run `neo4j-admin copy` providing the location where the copy will be created.
- [ ] With the Neo4j instance stopped, run `neo4j-admin copy` providing the location where the copy will be created.
- [ ] With the Neo4j instance started, run `neo4j-admin dump` providing the location where the dump file will be created.
- [x] With the Neo4j instance stopped, run `neo4j-admin dump` providing the location where the dump file will be created.
////

== Summary

You should now be able to back up and restore a Neo4j database.

////
== Grade Quiz and Continue 

++++
<a class="next-section medium button" href="../part-4/">Continue to Module 4</a>
++++

ifdef::backend-html5[]

include::scripts-end.txt[]
++++
<script>
$( document ).ready(function() {
  Intercom('trackEvent','training-admin-view-part3');
});
</script>
++++

endif::backend-html5[]
////
